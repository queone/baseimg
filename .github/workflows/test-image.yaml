name: Test Image
# Two separate jobs are neeeded because Gihtub doesn't support dynamically
# getting the image_name and test_tag values.

on:
  workflow_dispatch:
    inputs:
      dockerfile:
        description: "Select the Dockerfile to use"
        required: true
        type: choice
        options:
          - Dockerfile.base
          - Dockerfile.vault
      version:
        description: "Specify the version to test (e.g., 1.0.0, leave empty for latest)"
        required: false
        type: string

jobs:
  extract-info:
    # This job is to get the image_name and test_tag
    runs-on: ubuntu-latest
    outputs:
      image_name: ${{ steps.extract.outputs.image_name }}
      test_tag: ${{ steps.versioning.outputs.test_tag }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ensure all tags are fetched

      - name: Extract image name from Dockerfile
        id: extract
        run: |
          IMAGE_NAME=$(.github/scripts/extract-image-name.sh ${{ github.event.inputs.dockerfile }})
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT

      - name: Determine version tag
        id: versioning
        run: |
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            TEST_TAG="${{ github.event.inputs.version }}"
          else
            TEST_TAG=$(.github/scripts/determine-version.sh)
          fi
          echo "test_tag=$TEST_TAG" >> $GITHUB_OUTPUT

  test-container:
    # This job uses image_name and test_tag to be tested 
    runs-on: ubuntu-latest
    needs: extract-info
    container:
      image: ghcr.io/queone/${{ needs.extract-info.outputs.image_name }}:${{ needs.extract-info.outputs.test_tag }}

    steps:
      - name: Setup Go environment
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.4'

      - name: Test COMMANDS
        run: |
          set -e
          chmod +x /bin/sh || true
          Gre='\e[1;32m' Red='\e[1;31m' Pur='\e[1;35m' Yel='\e[1;33m' Blu='\e[1;34m' Rst='\e[0m'
          printf "${Gre}START${Rst}\n"
          git --version || echo "git not found"
          ls -l
          cat /etc/os-release
          uname -m
          go version || echo "go not found"
          vault version || echo "vault not found"
          printf "${Red}END!${Rst}\n"
